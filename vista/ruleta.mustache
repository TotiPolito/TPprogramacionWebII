<html>
<head>
    <title>Ruleta</title>
    <link rel="stylesheet" href="{{BASE_URL}}/public/style/style.css">
    <link rel="stylesheet" href="{{BASE_URL}}/public/style/headerFooter.css">
    <link rel="stylesheet" href="{{BASE_URL}}/public/style/ruleta.css">
</head>

<body class="body_ruleta">

<h2>Girá la ruleta</h2>

<div class="ruleta-container" style="width:260px; height:260px;">
    <div class="puntero"></div>

    <div id="ruleta"></div>

    <div id="resultado" class="resultado">
        <span id="textoResultado">...</span>
        <span id="detalle" class="detalle"></span>
    </div>
</div>

<button id="btnGirar" class="btnGirar">Girar</button>

<script>
    const categorias = [
        {{#categorias}}
            "{{.}}",
        {{/categorias}}
    ];

    console.log("Categorias detectadas:", categorias);
    const coloresFijos = {
        deportes: "#ef9222",
        historia: "#fdd730",
        arte: "#f63232",
        ciencia: "#4dfd3a",
        geografia: "#3498db",
        entretenimiento: "#ed479d"
    };
    function generarColorDesdeHash(texto) {
        const hash = parseInt(md5(texto).substring(0, 6), 16);
        return "#" + hash.toString(16).padStart(6, "0");
    }
    function md5(str){return CryptoJS.MD5(str).toString();}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
    const colores = categorias.map(cat =>
            coloresFijos[cat.toLowerCase()] ?? generarColorDesdeHash(cat)
    );

    console.log("Colores asignados:", colores);

    const ruleta = document.getElementById("ruleta");
    const btn = document.getElementById("btnGirar");
    const resultadoDiv = document.getElementById("resultado");
    const textoResultado = document.getElementById("textoResultado");

    const sector = 360 / categorias.length;

    function generarGradiente() {
        let partes = [];
        for (let i = 0; i < categorias.length; i++) {
            const inicio = i * sector;
            const fin = inicio + sector;
            partes.push(`${colores[i]} ${inicio}deg ${fin}deg`);
        }
        return "conic-gradient(" + partes.join(",") + ")";
    }

    ruleta.style.background = generarGradiente();

    let rotacionActual = 0;
    let girando = false;

    btn.onclick = () => {
        if (girando) return;
        girando = true;

        resultadoDiv.classList.remove("show");

        const extra = Math.floor(Math.random() * 360);
        const vueltas = 3600;
        const rotacionFinal = vueltas + extra;

        rotacionActual += rotacionFinal;
        ruleta.style.transform = `rotate(${rotacionActual}deg)`;

        const onEnd = () => {
            ruleta.removeEventListener("transitionend", onEnd);

            let angulo = rotacionActual % 360;
            angulo = (angulo + 270) % 360; // alineación con puntero superior

            const index = Math.floor(angulo / sector);
            const idx = (index + categorias.length) % categorias.length;

            const categoria = categorias[idx];
            const color = colores[idx];

            textoResultado.textContent = categoria;
            resultadoDiv.classList.add("show");

            ruleta.style.borderColor = color;

            setTimeout(() => {
                window.location.href =
                        "{{BASE_URL}}/Game/jugar?categoria=" +
                        encodeURIComponent(categoria) +
                        "&color=" +
                        encodeURIComponent(color);
                girando = false;
            }, 900);
        };

        ruleta.addEventListener("transitionend", onEnd);
    };

</script>

</body>
</html>
